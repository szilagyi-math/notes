% TeX format requirement
\NeedsTeXFormat{LaTeX2e}

% Package name [\usepackage{szb-env}]
\ProvidesPackage{szb-env}

\RequirePackage{kvoptions}
\RequirePackage{etoolbox}

\SetupKeyvalOptions{%
  family=szbenv,%
  prefix=szbenv@@%
}

\DeclareBoolOption[false]{etoc}

\ProcessKeyvalOptions*


% Required packages
\RequirePackage{szb-util}
\RequirePackage{szb-math}
\RequirePackage{szb-graphics}
\RequirePackage{szb-color}

\PassOptionsToPackage{framemethod=TikZ}{mdframed}
\RequirePackage{mdframed}
\RequirePackage{etoolbox}
\RequirePackage{xparse}

\ifszbenv@@etoc
  \RequirePackage{etoc}

  \addtotoclist{def}
  \newcommand{\listdefinitionsname}{Definíciók jegyzéke}
  \newcommand\listofdefinitions{\listoftoc[Definíciók jegyzéke]{def}}
  \setuptoc{def}{chapteratlist,leveldown}

  \addtotoclist{the}
  \newcommand{\listoftheoremsname}{Tételek jegyzéke}
  \newcommand\listoftheorems{\listoftoc[Tételek jegyzéke]{the}}
  \setuptoc{the}{chapteratlist,leveldown}
\fi


% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ DEFINITION ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdfdefinestyle{definition}{
  hidealllines              = true,%
  leftline                  = true,%
  linewidth                 = 3pt,%
  linecolor                 = primaryColor,%
  frametitlerule            = true,%
  frametitlebackgroundcolor = primaryColor,%
  backgroundcolor           = gray!10,%
  frametitleaboveskip       = 2mm,%
  frametitlebelowskip       = 2mm,%
  innertopmargin            = 3mm,%
}

\newcounter{definition}[section]
\numberwithin{definition}{section}

\NewDocumentEnvironment{definition}{s o O{} +b}{%
  \IfBooleanTF{#1}{}{%
    \refstepcounter{definition}%
    % \label{def:\thedefinition}%
    \IfBlankTF{#2}{}{\addcontentsline{def}{section}{\protect\numberline{\thedefinition}#2}}
  }%
  \def\rule@@color{primaryColor}%
  \begin{mdframed}[
      style=definition,%
      frametitle={
        \color{white}\sffamily\bfseries%
        Definíció\IfBooleanTF{#1}{}{~\thedefinition}%
        \IfBlankTF{#2}{}{\IfNoValueTF{#2}{}{ : #2}}%
      },%
      #3%
    ]%
  #4%
}{\end{mdframed}}

\NewDocumentEnvironment{definition*}{ o O{} +b }{%
  \begin{definition}*[\IfNoValueTF{#1}{}{\IfBlankTF{#2}{}{\unexpanded{#1}}}][#2]#3%
}{\end{definition}}

% % ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% % ~~~~~~~~~~~~~~~~~~~~~ THEOREM ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% % ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdfdefinestyle{theorem}{%
  hidealllines              = true,%
  leftline                  = true,%
  linewidth                 = 3pt,%
  linecolor                 = secondaryColor,%
  frametitlerule            = true,%
  frametitlebackgroundcolor = secondaryColor,%
  backgroundcolor           = gray!10,%
  frametitleaboveskip       = 2mm,%
  frametitlebelowskip       = 2mm,%
  innertopmargin            = 3mm,%
}

\newcounter{theorem}[section]
\numberwithin{theorem}{section}

\NewDocumentEnvironment{theorem}{s o O{} +b}{%
  \IfBooleanTF{#1}{}{%
    \refstepcounter{theorem}%
    % \label{the:\thetheorem}%
    \IfBlankTF{#2}{}{\addcontentsline{the}{section}{\protect\numberline{\thetheorem}#2}}
  }%
  \def\rule@@color{secondaryColor}%
  \begin{mdframed}[
      style=theorem,%
      frametitle={
        \color{white}\sffamily\bfseries%
        Tétel\IfBooleanTF{#1}{}{~\thetheorem}%
        \IfBlankTF{#2}{}{\IfNoValueTF{#2}{}{ : #2}}%
      },%
      #3%
    ]%
  #4%
}{\end{mdframed}}

\NewDocumentEnvironment{theorem*}{ o O{} +b }{%
  \begin{theorem}*[\IfNoValueTF{#1}{}{\IfBlankTF{#2}{}{\unexpanded{#1}}}][#2]#3%
}{\end{theorem}}


% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ BLUEBOX ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdfdefinestyle{blueBox}{%
  % NO LINES
  hidealllines      = true,%
  leftline          = true,%
  % COLORS
  backgroundcolor   = cyan!10,%
  linecolor         = secondaryColor,%
  % LENGTHS
  linewidth         = 3pt,%
  innertopmargin    = .66em,%
  innerbottommargin = .66em,%
}

\newcommand{\sftitle}[1]{{\bfseries\sffamily#1}}

\NewDocumentEnvironment{blueBox}{ o O{} +b }{%
  \def\rule@@color{secondaryColor}%
  \newif\ifszbenv@@blueboxtitle%
  \szbenv@@blueboxtitletrue%
  \IfNoValueTF{#1}{\szbenv@@blueboxtitlefalse}{}%
  \IfBlankTF{#1}{\szbenv@@blueboxtitlefalse}{}%
  %
  \ifszbenv@@blueboxtitle%
    \begin{mdframed}[%
      style=blueBox,%
      frametitle={
        \sffamily\bfseries%
        #1%
      },%
      #2%
    ]#3%
  \else%
    \begin{mdframed}[%
      style=blueBox,%
      #2%
    ]#3%
  \fi%
}{\end{mdframed}}



% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ NOTE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdfdefinestyle{note}{%
  % NO LINES
  hidealllines      = true,%
  leftline          = true,%
  % COLORS
  backgroundcolor   = yellow!10,%
  linecolor         = ternaryColor,%
  % LENGTHS
  linewidth         = 3pt,%
  innertopmargin    = .66em,%
  innerbottommargin = .66em,%
}

\NewDocumentEnvironment{note}{ o O{} +b }{%
  \def\rule@@color{ternaryColor}%
  \newif\ifszbenv@@notetitle%
  \szbenv@@notetitletrue%
  \IfNoValueTF{#1}{\szbenv@@notetitlefalse}{}%
  \IfBlankTF{#1}{\szbenv@@notetitlefalse}{}%
  %
  \ifszbenv@@notetitle%
    \begin{mdframed}[%
      style=note,%
      frametitlerule=true,%
      frametitlebackgroundcolor=ternaryColor,%
      frametitle={
        \color{white}\sffamily\bfseries%
        #1%
      },%
      #2%
    ]#3%
  \else%
    \begin{mdframed}[%
      style=note,%
      #2%
    ]#3%
  \fi%
}{\end{mdframed}}



% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ STATEMENT ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdfdefinestyle{statement}{%
  % NO LINES
  hidealllines      = true,%
  leftline          = true,%
  % COLORS
  backgroundcolor   = primaryColor!10,%
  linecolor         = primaryColor,%
  % LENGTHS
  linewidth         = 3pt,%
  innertopmargin    = .66em,%
  innerbottommargin = .66em,%
  % TIKZ
  singleextra={
    \path let \p1=(P), \p2=(O) in ($(\x2,0)+0.5*(0,\y1)$) node[
      rectangle,
      fill=primaryColor!10,
      draw=primaryColor,
      line width=2pt,
      overlay,
    ] {\color{primaryColor}\large!};
  },%
  firstextra={
    \path let \p1=(P), \p2=(O) in ($(\x2,0)+0.5*(0,\y1)$) node[
      rectangle,
      fill=primaryColor!10,
      draw=primaryColor,
      line width=2pt,
      overlay,
    ] {\color{primaryColor}\large!};
  },
  secondextra={
    \path let \p1=(P), \p2=(O) in ($(\x2,0)+0.5*(0,\y1)$) node[
      rectangle,
      fill=primaryColor!10,
      draw=primaryColor,
      line width=2pt,
      overlay,
    ] {\color{primaryColor}\large!};
  },
}


\NewDocumentEnvironment{statement}{ o O{} +b }{%
  \newif\ifszbenv@@statementtitle%
  \szbenv@@statementtitletrue%
  \IfNoValueTF{#1}{\szbenv@@statementtitlefalse}{}%
  \IfBlankTF{#1}{\szbenv@@statementtitlefalse}{}%
  \def\rule@@color{primaryColor}%
  %
  \ifszbenv@@statementtitle%
    \begin{mdframed}[
      style=statement,%
      frametitle={
        \sffamily\bfseries%
        #1%
      },%
      #2%
    ]#3%
  \else%
    \begin{mdframed}[style=statement,#2]#3%
  \fi
}{\end{mdframed}}



% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ LEARN MORE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdf@do@stringoption{learnMoreTitle=={Kitekintő}}
\usetikzlibrary{calc,arrows,backgrounds}
\tikzset{
  excursus arrow/.style={%
      line width=2pt,
      draw=secondaryColor,
      rounded corners=1ex,
    },
  excursus head/.style={
      font=\bfseries\sffamily,
      anchor=base west,
      text=secondaryColor,
      inner sep=1.5ex,
      inner ysep=1ex,
    },
}
\mdfdefinestyle{learnMore}{%
  singleextra={%
    % NODE LEFT BOTTOM
    \path let \p1=(P), \p2=(O) in (\x2,\y1) coordinate (Q);
    % BOTTOM-LEFT
    \path let \p1=(Q), \p2=(O) in (\x1,\y2) coordinate (BL);
    % TOP RIGHT
    \path let \p1=(Q), \p2=(P) in (\x2,\y1) coordinate (TR);
    % TITLE
    \node [excursus head] (A) at ($(Q)+(2.5em,0)$) {\phantom{\mdf@digressiontitle}};
    % ARROW
    \path [excursus arrow, line width=2pt] ($(BL)+(1pt,0)$) |- ($(Q)+(2em,0)$);
    \path [excursus arrow, line width=2pt, fill=gray!10, -to]
      ($(Q)+(1em,0)$)
      -| (A.north west)
      -| (A.base east)
      -- (TR)
      ;
    % \fill [gray!10]
    %   ($(A.base east)+(1em,0)$)
    %   -- ++(2em,0)
    %   .. controls ($(TR)!0.2!(A.base east)+(0,1ex)$) .. ($(TR)+(0,2ex)$)
    %   -- ++(0,-2ex)
    %   -- cycle
    % ;
    % \path [excursus arrow, round cap-to]
    %   ($(A.base east)+(1em,0)$)
    %   -- ++(2em,0)
    %   .. controls ($(TR)!0.2!(A.base east)+(0,1ex)$) .. ($(TR)+(0,2ex)$)
    % ;
    \node [excursus head] (A) at ($(Q)+(2.5em,0)$) {\mdf@digressiontitle};
  },
  backgroundcolor   = gray!10,
  middlelinewidth   = 0,
  hidealllines      = true,
  topline           = true,
  innertopmargin    = 2.5ex,
  innerbottommargin = 1.5ex,
  innerrightmargin  = 2ex,
  innerleftmargin   = 2ex,
  skipabove         = 0.5\baselineskip,
  nobreak           = true,
}

\newenvironment{learnMore}[1][Kitekintő]{%
  \def\mdf@digressiontitle{#1}%
  \begin{mdframed}[style=learnMore]
    }{%
  \end{mdframed}
}



% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ EXAMPLE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\mdfdefinestyle{example}{%
  % NO LINES
  hidealllines      = true, 
  leftline          = true,
  % COLORS
  backgroundcolor   = magenta!10, 
  linecolor         = magenta!60!black,
  % LENGTHS
  linewidth         = 3pt, 
  innertopmargin    = .66em, 
  innerbottommargin = .66em,
}

\NewDocumentEnvironment{example}{ o O{} +b }{%
  \def\rule@@color{magenta!60!black}%
  \newif\ifszbenv@@exampletitle%
  \szbenv@@exampletitletrue%
  \IfNoValueTF{#1}{\szbenv@@exampletitlefalse}{}%
  \IfBlankTF{#1}{\szbenv@@exampletitlefalse}{}%
  %
  \ifszbenv@@exampletitle%
    \begin{mdframed}[%
      style=example,%
      frametitle={
        \sffamily\bfseries%
        #1%
      },%
      #2%
    ]#3%
  \else%
    \begin{mdframed}[style=example,#2]#3%
  \fi%
}{\end{mdframed}}



% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~ PROOF ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\RequirePackage{dashrule}
\newenvironment{proof}[1][\@nil]{%
  \def\tmp{#1}%
  % HORIZONTAL DASHED RULE WITH rule@@color
  {\color{\rule@@color}\hdashrule[.8ex][x]{\dimexpr\textwidth}{1pt}{2mm 3pt}}
  % PROOF TITLE
  {%
    \sffamily\textbf{Bizonyítás}%
    \ifx\tmp\@nnil
      :%
    \else%
      \ (#1):%
    \fi
  }\par
}{%
}
\newcommand\boxrule{{\color{\rule@@color}\hdashrule[.8ex][x]{\dimexpr\textwidth}{1pt}{2mm 3pt}}}